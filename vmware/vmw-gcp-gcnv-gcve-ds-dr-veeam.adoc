---
sidebar: sidebar 
permalink: vmware/vmw-gcp-gcnv-gcve-ds-dr-veeam.html 
keywords: disaster recovery, avs, google cloud, gcp, gcve, gcnv, google cloud netapp volumes, netapp volumes, dr, veeam, replication 
summary:  
---
= 使用 Veeam Replication 和Google Cloud NetApp Volumes資料儲存區實現 Google Cloud VMware Engine 的災難復原
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
在危機時刻，全面的災難復原計畫對企業來說至關重要。許多組織利用雲端運算進行日常營運和災難復原。這種主動的方法可以減少或消除昂貴的業務中斷。

本文介紹如何使用 Veeam Backup & Replication 設定本機 VMware VM 到具有Google Cloud NetApp Volumes (NetApp Volumes) 的 Google Cloud VMware Engine (GCVE) 的災難復原。



== 概況

Google Cloud NetApp Volumes是 Google 和NetApp推出的儲存服務，可用於 Google Cloud。  NetApp Volumes 服務提供高效能 NFS/SMB 儲存。 VMware 認證的NetApp Volumes NFS 儲存可用作 GCVE 中 ESXi 主機的外部資料儲存。使用者需要在其 GCVE 私有雲和NetApp Volumes 專案之間建立對等連線。區域內的儲存存取不會產生任何網路費用。使用者可以在 Google Cloud 控制台中建立NetApp Volumes 卷，並在將磁碟區作為資料儲存區掛載到其 ESXi 主機之前啟用刪除保護。

基於NetApp Volumes 的 NFS 資料儲存區可用於使用任何經過驗證且提供 VM 複製功能的第三方解決方案從本機複製資料。透過新增NetApp Volumes 資料存儲，可以實現成本優化部署，而無需建立基於 Google Cloud VMware Engine (GCVE) 的 SDDC 並使用大量 ESXi 主機來容納儲存。這種方法被稱為「Pilot Light Cluster」。試點燈叢集是最小 GCVE 主機配置（3 x GCVE ESXi 主機）以及NetApp Volumes 資料儲存容量，以允許獨立擴展以滿足容量需求。

目標是僅使用管理故障轉移的核心組件來維持具有成本效益的基礎設施。在發生故障轉移時，指示燈叢集可以擴展並新增更多 GCVE 主機。一旦故障轉移得到解決並且正常運作恢復，指示燈叢集就可以縮小規模，回到低成本的運作模式。



== 本文件的目的

本文介紹如何使用Google Cloud NetApp Volumes資料儲存和 Veeam Backup & Replication 來設定本地 VMware VM 到 GCVE 的災難復原（使用 Veeam VM 複製軟體功能）。

Veeam Backup & Replication 是一款用於虛擬環境的備份和複製應用程式。當虛擬機器被複製時，Veeam Backup & Replication 會在目標 GCVE SDDC 叢集上以原生 VMware vSphere 格式建立虛擬機器的精確副本。 Veeam Backup & Replication 將使副本與原始 VM 保持同步。複製提供了最佳的復原時間目標 (RTO)，因為 DR 站點上有一個處於準備啟動狀態的 VM 的安裝副本。

這種複製機制確保在災難事件發生時工作負載能夠在 GCVE 中快速啟動。 Veeam Backup & Replication 軟體也優化了透過 WAN 和慢速連線進行複製的流量傳輸。此外，它還過濾掉重複的資料區塊、零資料區塊、交換檔案和「排除的 VM 客戶作業系統檔案」。該軟體還將壓縮副本流量。為了防止複製作業消耗整個網路頻寬，可以利用 WAN 加速器和網路限制規則。

Veeam Backup & Replication 中的複製過程由作業驅動，這表示複製是透過設定複製作業來執行的。如果發生災難事件，可以觸發故障轉移，透過故障轉移到其副本來恢復虛擬機器。當執行故障轉移時，複製的虛擬機器將接管原始虛擬機器的角色。可以執行故障轉移至副本的最新狀態或任何已知的良好還原點。這使得勒索軟體恢復或隔離測試能夠根據需要進行。  Veeam Backup & Replication 提供多種選項來處理不同的災難復原場景。



== 解決方案概述

此解決方案涵蓋以下進階步驟：

. 使用Google Cloud NetApp Volumes建立 NFS 卷
. 依照 GCP 流程從NetApp Volumes NFS 磁碟區建立 GCVE 資料儲存。
. 設定複製作業以使用 Veeam Backup & Replication 建立 VM 副本。
. 建立故障轉移計劃並執行故障轉移。
. 災難事件結束且主站點啟動後，切換回生產虛擬機器。



NOTE: 在NetApp Volumes 中建立磁碟區作為 GCVE 資料儲存時，僅支援 NFS v3。

有關使用NetApp Volumes NFS 磁碟區作為 GCVE 資料儲存的更多信息，請查看 https://cloud.google.com/vmware-engine/docs/vmware-ecosystem/howto-cloud-volumes-datastores-gcve["使用 NFS 磁碟區作為由Google Cloud NetApp Volumes託管的 vSphere 資料存儲"]。



== 架構

下圖顯示了本文檔中提出的解決方案的架構。建議的最佳實踐是在本機站點和 GCVE SDDC 中都安裝一個 Veeam Backup & Replication 伺服器。備份和復原由內部部署的 Veeam 伺服器執行和管理，複製由 GCVE SDDC 中的 Veeam 伺服器管理。當主資料中心發生故障時，此架構可提供最高的可用性。

image::dr-veeam-gcnv-001.png[架構圖]



== Veeam 複製到 GCVE 和NetApp Volumes 資料儲存區的先決條件

此解決方案需要以下元件和配置：

. NetApp Volumes 有一個可用的儲存池，具有足夠的可用容量來容納要建立的 NFS 磁碟區。
. Veeam Backup and Replication 軟體在具有適當網路連線的本機環境中運作。
. 確保 Veeam Backup & Replication 備份 VM 連線到來源以及目標 GCVE SDDC 叢集。
. 確保 Veeam Backup & Replication 備份 VM 連線到來源和目標 GCVE 叢集上的 Veeam 代理伺服器 VM。
. 備份伺服器必須能夠解析短名稱並連接到來源 vCenter 和目標 vCenter。


使用者需要使用 VMware Engine Cloud 控制台 UI 中的 VPC 網路對等或私有連線頁面在其 GCVE 私有雲和NetApp Volumes 專案之間建立對等連線。


NOTE: 將 GCVE vCenter 伺服器新增至 Veeam Backup and Replication 清單時，Veeam 需要具有提升權限的 GCVE 解決方案使用者帳戶。有關更多信息，請參閱 Google Cloud Platform (GCP) 文檔， https://cloud.google.com/vmware-engine/docs/private-clouds/classic-console/howto-elevate-privilege["提升 VMware Engine 權限"] 。

有關更多信息，請參閱 https://helpcenter.veeam.com/docs/backup/vsphere/replica_limitations.html?ver=120["注意事項和限制"]在 Veeam Backup & Replication 文件中。



== 部署步驟

以下部分概述了使用Google Cloud NetApp Volumes建立和掛載 NFS 資料儲存的部署步驟，以及使用 Veeam Backup and Replication 在本機資料中心和 Google Cloud VMware Engine 之間實施完整災難復原解決方案的步驟。



=== 為 GCVE 建立NetApp Volumes NFS 捲和資料存儲

參考 https://cloud.google.com/vmware-engine/docs/vmware-ecosystem/howto-cloud-volumes-datastores-gcve["使用 NFS 磁碟區作為由Google Cloud NetApp Volumes託管的 vSphere 資料存儲"]了解如何將Google Cloud NetApp Volumes作為 GCVE 的資料儲存的概述。

完成以下步驟以使用NetApp Volumes 為 GCVE 建立和使用 NFS 資料儲存：

.建立NetApp Volumes NFS 卷
[%collapsible%open]
====
可從 Google Cloud Platform (GCP) 控制台存取Google Cloud NetApp Volumes 。

參考 https://cloud.google.com/netapp/volumes/docs/configure-and-use/volumes/create-volume["創建卷"]有關此步驟的詳細信息，請參閱Google Cloud NetApp Volumes文件。

. 在 Web 瀏覽器中，導覽至 https://console.cloud.google.com/[]並登入您的 GCP 控制台。搜尋 * NetApp Volumes* 開始。
. 在* NetApp Volumes* 管理介面中，按一下* Create* 開始建立 NFS 磁碟區。
+
image::dr-veeam-gcnv-002.png[創建卷]

+
{nbsp}

. 在「建立磁碟區」精靈中，填寫所有必需的資訊：
+
** 卷的名稱。
** 建立磁碟區的儲存池。
** 掛載 NFS 磁碟區時使用的共用名稱。
** 卷的容量（以 GiB 為單位）。
** 要使用的儲存協定。
** 勾選此方塊以*客戶端連線時阻止刪除磁碟區*（GCVE 作為資料儲存安裝時需要）。
** 訪問卷的導出規則。這是 NFS 網路上 ESXi 適配器的 IP 位址。
** 用於使用本機快照保護磁碟區的快照計劃。
** 或者，選擇備份磁碟區和/或為磁碟區建立標籤。
+

NOTE: 在NetApp Volumes 中建立磁碟區作為 GCVE 資料儲存時，僅支援 NFS v3。

+
image::dr-veeam-gcnv-003.png[創建卷]

+
{nbsp}

+
image::dr-veeam-gcnv-004.png[創建卷]

+
{nbsp} 按一下「*建立*」以完成磁碟區的建立。



. 一旦建立了磁碟區，就可以從磁碟區的屬性頁面查看掛載磁碟區所需的 NFS 匯出路徑。
+
image::dr-veeam-gcnv-005.png[體積屬性]



====
.在 GCVE 中掛載 NFS 資料存儲
[%collapsible%open]
====
在撰寫本文時，在 GCVE 中掛載資料儲存的過程需要開啟 GCP 支援票證才能將磁碟區掛載為 NFS 資料儲存。

參考 https://cloud.google.com/vmware-engine/docs/vmware-ecosystem/howto-cloud-volumes-datastores-gcve["使用 NFS 磁碟區作為由Google Cloud NetApp Volumes託管的 vSphere 資料存儲"]了解更多。

====


=== 將虛擬機器複製到 GCVE 並執行故障轉移計劃和故障回复

.將虛擬機器複製到 GCVE 中的 NFS 資料存儲
[%collapsible%open]
====
Veeam Backup & Replication 在複製期間利用 VMware vSphere 快照功能，Veeam Backup & Replication 請求 VMware vSphere 建立 VM 快照。  VM 快照是 VM 的時間點副本，其中包括虛擬磁碟、系統狀態、配置和元資料。  Veeam Backup & Replication 使用快照作為複製的資料來源。

若要複製虛擬機，請完成以下步驟：

. 開啟 Veeam 備份和複製控制台。
. 在“主頁”標籤上，按一下“複製作業”>“虛擬機器...”
+
image::dr-veeam-gcnv-006.png[建立虛擬機器複製作業]

+
{nbsp}

. 在「新複製作業」精靈的「名稱」頁面上，指定作業名稱並選擇適當的進階控制複選框。
+
** 如果本機和 GCP 之間的連線頻寬受限，請勾選「副本播種」複選框。
** 如果 GCVE SDDC 上的段與本機站點網路的段不匹配，請選取網路重新對應（針對具有不同網路的 GCVE SDDC 站點）複選框。
** 如果本機生產站點中的 IP 位址方案與目標 GCVE 站點中的方案不同，請選取副本重新 IP（適用於具有不同 IP 位址方案的 DR 站點）核取方塊。
+
image::dr-veeam-gcnv-007.png[姓名頁]

+
{nbsp}



. 在「虛擬機器」頁面上，選擇要複製到連接到 GCVE SDDC 的NetApp磁碟區資料儲存區的虛擬機器。按一下*新增*，然後在*新增物件*視窗中選擇必要的虛擬機器或虛擬機器容器，然後按一下*新增*。按一下“下一步”。
+

NOTE: 可以將虛擬機器放置在 vSAN 上以填入可用的 vSAN 資料儲存容量。在試點叢集中，3 節點 vSAN 叢集的可用容量將受到限制。其餘資料可以輕鬆放置在Google Cloud NetApp Volumes資料儲存中，以便可以恢復虛擬機，並且可以稍後擴展叢集以滿足 CPU/記憶體需求。

+
image::dr-veeam-gcnv-008.png[選擇要複製的虛擬機]

+
{nbsp}

. 在*目標*頁面上，選擇目標作為 GCVE SDDC 叢集/主機，並為 VM 副本選擇適當的資源池、VM 資料夾和NetApp Volumes 資料儲存。按一下“*下一步*”繼續。
+
image::dr-veeam-gcnv-009.png[選擇目的地詳情]

+
{nbsp}

. 在「網路」頁面上，根據需要建立來源虛擬網路和目標虛擬網路之間的對應。按一下“*下一步*”繼續。
+
image::dr-veeam-gcnv-010.png[網路映射]

+
{nbsp}

. 在*Re-IP*頁面上，按一下*Add...*按鈕新增新的re-ip規則。填寫來源和目標虛擬機器 IP 範圍以指定在故障轉移時將套用於來源虛擬機器的網路。使用星號來指定該八位元組的位址範圍。按一下“*下一步*”繼續。
+
image::dr-veeam-gcnv-011.png[重新 IP 頁面]

+
{nbsp}

. 在「*作業設定*」頁面上，指定將儲存 VM 副本元資料的備份儲存庫、保留策略，然後選擇底部的「*進階...*」按鈕以進行其他作業設定。按一下“*下一步*”繼續。
. 在*資料傳輸*上，選擇位於來源網站和目標網站的代理伺服器，並保持選擇直接選項。如果配置了 WAN 加速器，也可以在這裡選擇。按一下“*下一步*”繼續。
+
image::dr-veeam-gcnv-012.png[資料傳輸]

+
{nbsp}

. 在*Guest Processing*頁面上，根據需要選取*Enable application-aware processing*複選框，並選擇*Guest OS credentials*。按一下“*下一步*”繼續。
+
image::dr-veeam-gcnv-013.png[客人處理]

+
{nbsp}

. 在「*計畫*」頁面上，定義複製作業運作的時間和頻率。按一下“*下一步*”繼續。
+
image::dr-veeam-gcnv-014.png[日程安排頁面]

+
{nbsp}

. 最後，在*摘要*頁面上檢查作業設定。勾選「*按一下完成時執行該作業*」複選框，然後按一下「*完成*」即可完成建立複製作業。
. 一旦運行，就可以在作業狀態視窗中查看複製作業。
+
image::dr-veeam-gcnv-015.png[作業狀態視窗]

+
有關 Veeam 複製的更多信息，請參閱link:https://helpcenter.veeam.com/docs/backup/vsphere/replication_process.html?ver=120["複製的工作原理"]



====
.建立故障轉移計劃
[%collapsible%open]
====
初始複製或播種完成後，建立故障轉移計劃。故障轉移計畫有助於自動對從屬虛擬機器逐一或按群組執行故障轉移。故障轉移計劃是虛擬機器處理順序（包括啟動延遲）的藍圖。故障轉移計劃還有助於確保關鍵依賴的虛擬機器已經在運作。

完成初始複製或播種後，建立故障轉移計劃。該計劃可作為協調依賴虛擬機器（單獨或作為一個群組）故障轉移的策略藍圖。它定義了虛擬機器的處理順序，包含了必要的啟動延遲，並確保關鍵的依賴虛擬機器在其他虛擬機器之前運行。透過實施結構良好的故障轉移計劃，組織可以簡化其災難復原流程，最大限度地減少停機時間並在故障轉移事件期間維護相互依賴系統的完整性。

建立計劃時，Veeam Backup & Replication 會自動識別並使用最新的還原點來啟動 VM 副本。


NOTE: 僅當初始複製完成且 VM 副本處於就緒狀態時，才能建立故障轉移計劃。


NOTE: 執行故障轉移計畫時可同時啟動的最大虛擬機器數量為 10 個。


NOTE: 在故障轉移過程中，來源虛擬機器不會關閉。

若要建立*故障轉移計劃*，請完成以下步驟：

. 在*主頁*視圖上，按一下*恢復*部分中的*故障轉移計劃*按鈕。在下拉式選單中，選擇 *VMware vSphere...*
+
image::dr-veeam-gcnv-016.png[建立故障轉移計劃]

+
{nbsp}

. 在「新故障轉移計畫」精靈的「常規」頁面上，提供計畫的名稱和說明。可根據需要新增故障轉移前和故障轉移後腳本。例如，在啟動複製的虛擬機器之前執行腳本來關閉虛擬機器。
+
image::dr-veeam-gcnv-017.png[常規頁面]

+
{nbsp}

. 在“虛擬機器”頁面上，按一下“新增虛擬機器”按鈕並選擇“從副本...”。選擇作為故障轉移計畫一部分的虛擬機，然後修改虛擬機啟動順序和任何所需的啟動延遲以滿足應用程式依賴關係。
+
image::dr-veeam-gcnv-018.png[虛擬機器頁面]

+
{nbsp}

+
image::dr-veeam-gcnv-019.png[啟動順序和延遲]

+
{nbsp}

+
點選“*應用*”繼續。

. 最後檢查所有故障轉移計劃設置，然後按一下「完成」以建立故障轉移計劃。


有關建立複製作業的其他信息，請參閱link:https://helpcenter.veeam.com/docs/backup/vsphere/replica_job.html?ver=120["建立複製作業"]。

====
.運行故障轉移計劃
[%collapsible%open]
====
在故障轉移期間，生產站點中的來源虛擬機器將切換到災難復原站點上的副本。作為該過程的一部分，Veeam Backup & Replication 將 VM 副本還原到所需的復原點，並將所有 I/O 活動從來源 VM 傳輸到其副本。複製品不僅可用於實際災難，還可用於模擬災難復原演習。在故障轉移模擬中，來源虛擬機器繼續運作。完成必要的測試後，可以撤銷故障轉移，恢復正常操作。


NOTE: 確保網路分段到位，以避免故障轉移期間發生 IP 衝突。

完成以下步驟以啟動故障轉移計畫：

. 首先，在*主頁*視圖中，按一下左側功能表中的*副本 > 故障轉移計劃*，然後按一下*開始*按鈕。或者，可以使用「*開始到...*」按鈕將故障轉移到先前的還原點。
+
image::dr-veeam-gcnv-020.png[啟動故障轉移計劃]

+
{nbsp}

. 在*執行故障轉移計劃*視窗中監控故障轉移的進度。
+
image::dr-veeam-gcnv-021.png[監視故障轉移進度]

+
{nbsp}




NOTE: Veeam Backup & Replication 停止來源 VM 的所有複製活動，直到其副本返回就緒狀態。

有關故障轉移計劃的詳細信息，請參閱link:https://helpcenter.veeam.com/docs/backup/vsphere/failover_plan.html?ver=120["故障轉移計劃"]。

====
.故障恢復到生產站點
[%collapsible%open]
====
進行故障轉移被視為中間步驟，需要根據要求最終確定。選項包括以下內容：

* *故障恢復到生產* - 恢復到原始虛擬機器並將副本活動期間所做的所有修改同步回來源虛擬機器。



NOTE: 在故障復原期間，變更會被傳輸但不會立即套用。驗證原始虛擬機器的功能後，選擇「提交故障復原」。或者，如果原始虛擬機器表現出意外行為，請選擇「撤銷故障回應」以還原至虛擬機器副本。

* *撤銷故障轉移* - 恢復到原始 VM，丟棄在運行期間對 VM 副本所做的所有變更。
* *永久故障轉移* - 從原始虛擬機器永久切換到其副本，並將副本建立為正在進行的操作的新主虛擬機器。


在這種情況下，選擇了“故障恢復到生產”選項。

完成以下步驟以故障還原為生產站點：

. 從*主頁*視圖中，按一下左側選單中的*副本>活動*。選擇要包含的虛擬機，然後點擊頂部選單中的「故障恢復到生產」按鈕。
+
image::dr-veeam-gcnv-022.png[啟動故障回復]

+
{nbsp}

. 在「故障回覆」精靈的「副本」頁面上，選擇要包含在故障回復作業中的副本。
. 在*目標*頁面上，選擇*故障還原到原始虛擬機器*，然後按一下*下一步*繼續。
+
image::dr-veeam-gcnv-023.png[故障恢復至原始虛擬機]

+
{nbsp}

. 在「故障復原模式」頁面上，選擇「自動」以盡快啟動故障復原。
+
image::dr-veeam-gcnv-024.png[故障回復模式]

+
{nbsp}

. 在“摘要”頁面上，選擇是否“恢復後啟動目標虛擬機器”，然後按一下“完成”以啟動故障復原作業。
+
image::dr-veeam-gcnv-025.png[故障回復作業摘要]

+
{nbsp}



故障回復提交完成故障回復操作，確認變更已成功整合至生產虛擬機器。提交後，Veeam Backup & Replication 將恢復已復原的生產虛擬機器的常規複製活動。這會將恢復的副本的狀態從_故障回復_更改為_就緒_。

. 若要提交故障回复，請導航至 *Replicas > Active*，選擇要提交的虛擬機，右鍵單擊並選擇 *Commit failback*。
+
image::dr-veeam-gcnv-026.png[提交故障回復]

+
{nbsp}

+
image::dr-veeam-gcnv-027.png[提交故障回復成功]

+
{nbsp} 故障恢復到生產環境成功後，所有虛擬機器都將恢復到原始生產站點。



有關故障恢復過程的詳細信息，請參閱 Veeam 文檔link:https://helpcenter.veeam.com/docs/backup/vsphere/failover_failback.html?ver=120["複製的故障轉移和故障恢復"]。

====


== 結論

Google Cloud NetApp Volumes資料儲存功能可讓 Veeam 和其他經過驗證的第三方工具提供經濟高效的災難復原 (DR) 解決方案。透過利用 Pilot Light 集群而不是用於 VM 副本的大型專用集群，組織可以顯著降低開支。這種方法可以實現客製化的 DR 策略，利用現有的內部備份解決方案進行基於雲端的災難恢復，從而無需額外的內部資料中心。如果發生災難，只需按一下即可啟動故障轉移或配置為自動發生故障轉移，從而確保業務連續性並將停機時間降至最低。

要了解有關此過程的更多信息，請隨意觀看詳細的演示視頻。

video::b2fb8597-c3fe-49e2-8a84-b1f10118db6d[panopto,width=Video walkthrough of the solution]