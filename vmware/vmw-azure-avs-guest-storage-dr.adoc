---
sidebar: sidebar 
permalink: vmware/vmw-azure-avs-guest-storage-dr.html 
keywords: tr4935, 4935, azure, avs, jetstream, guest connect, dr, disaster recovery 
summary: 雲端災難復原是一種具有彈性且經濟高效的方法，可保護工作負載免受網站中斷和勒索軟體等資料損壞事件的影響。透過NetApp SnapMirror，使用來賓連接儲存的本機 VMware 工作負載可以複製到在 Azure 中執行的NetApp Cloud Volumes ONTAP 。 
---
= 使用 CVO 和 AVS（來賓連接儲存）進行災難復原
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
雲端災難復原是一種具有彈性且經濟高效的方法，可保護工作負載免受網站中斷和勒索軟體等資料損壞事件的影響。透過NetApp SnapMirror，使用來賓連接儲存的本機 VMware 工作負載可以複製到在 Azure 中執行的NetApp Cloud Volumes ONTAP 。



== 概況

 This covers application data; however, what about the actual VMs themselves. Disaster recovery should cover all dependent components, including virtual machines, VMDKs, application data, and more. To accomplish this, SnapMirror along with Jetstream can be used to seamlessly recover workloads replicated from on-premises to Cloud Volumes ONTAP while using vSAN storage for VM VMDKs.
本文檔提供了使用NetApp SnapMirror、JetStream 和 Azure VMware 解決方案 (AVS) 設定和執行災難復原的逐步方法。

image:dr-cvo-avs-001.png["此圖顯示輸入/輸出對話框或表示書面內容"]



== 假設

本文檔重點介紹應用程式資料的客戶機內儲存（也稱為客戶機連線），我們假設本機環境使用SnapCenter進行應用程式一致性備份。


NOTE: 本文檔適用於任何第三方備份或復原解決方案。根據環境中使用的解決方案，遵循最佳實務來建立符合組織 SLA 的備份策略。

對於本機環境和 Azure 虛擬網路之間的連接，請使用快速路由全球覆蓋或具有 VPN 閘道的虛擬 WAN。應根據內部部署 vLAN 設計建立段。


NOTE: 將本機資料中心連接到 Azure 有多種選擇，因此我們無法在本文檔中概述特定的工作流程。請參閱 Azure 文檔，以了解適當的本地到 Azure 連線方法。



== 部署災難復原解決方案



=== 解決方案部署概述

. 確保使用SnapCenter備份應用程式資料並滿足必要的 RPO 要求。
. 使用適當的訂閱和虛擬網路中的雲端管理器為Cloud Volumes ONTAP配置正確的執行個體大小。
+
.. 為相關應用程式磁碟區設定SnapMirror 。
.. 更新SnapCenter中的備份策略以在排程的作業之後觸發SnapMirror更新。


. 在本地資料中心安裝 JetStream DR 軟體並啟動對虛擬機器的保護。
. 在 Azure VMware 解決方案私有雲中安裝 JetStream DR 軟體。
. 在災難事件期間，使用 Cloud Manager 中斷SnapMirror關係並觸發虛擬機器到Azure NetApp Files或指定 AVS DR 站點中的 vSAN 資料儲存的故障轉移。
+
.. 重新連接應用程式虛擬機器的 ISCSI LUN 和 NFS 掛載。


. 主站點恢復後，透過反向重新同步SnapMirror呼叫故障回復到受保護站點。




=== 部署詳情

.在 Azure 上設定 CVO 並將磁碟區複製到 CVO
[%collapsible%open]
====
第一步是在 Azure 上設定Cloud Volumes ONTAP （link:vmw-azure-avs-guest-storage.html["關聯"^] ) 並以所需的頻率和快照保留將所需的磁碟區複製到Cloud Volumes ONTAP 。

image:dr-cvo-avs-002.png["此圖顯示輸入/輸出對話框或表示書面內容"]

====
.配置 AVS 主機和 CVO 資料存取
[%collapsible%open]
====
部署 SDDC 時需要考慮的兩個重要因素是 Azure VMware 解決方案中 SDDC 叢集的大小以及保持 SDDC 服務的時間。災難復原解決方案的這兩個關鍵考慮因素有助於降低整體營運成本。  SDDC 最小可以只有三台主機，最大可以達到全面部署的多主機叢集。

部署 AVS 叢集的決定主要基於 RPO/RTO 要求。透過 Azure VMware 解決方案，可以及時配置 SDDC，為測試或實際災難事件做好準備。當您不處理災難時，及時部署的 SDDC 可以節省 ESXi 主機成本。然而，這種部署形式會在配置 SDDC 時影響 RTO 數小時。

最常見的部署選項是讓 SDDC 以始終開啟、指示燈亮起的操作模式運作。此選項佔用空間較小，僅需三個始終可用的主機，同時還透過為模擬活動和合規性檢查提供運行基線來加快恢復操作，從而避免生產站點和 DR 站點之間出現操作偏差的風險。當需要處理實際 DR 事件時，指示燈群集可以快速擴展到所需的等級。

若要設定 AVS SDDC（按需模式或指示燈模式），請參閱link:vmw-azure-avs-setup.html["在 Azure 上部署並配置虛擬化環境"^]。作為先決條件，請驗證在建立連線後，駐留在 AVS 主機上的客戶虛擬機器是否能夠使用來自Cloud Volumes ONTAP的資料。

正確配置Cloud Volumes ONTAP和 AVS 後，開始設定 Jetstream，透過使用 VAIO 機制並利用SnapMirror將應用程式磁碟區複製到Cloud Volumes ONTAP，自動將本機工作負載還原到 AVS（具有應用程式 VMDK 的虛擬機器和具有客戶機內儲存的虛擬機器）。

====
.在本地資料中心安裝 JetStream DR
[%collapsible%open]
====
JetStream DR 軟體由三個主要元件組成：JetStream DR 管理伺服器虛擬設備 (MSA)、DR 虛擬設備 (DRVA) 和主機元件（I/O 過濾套件）。 MSA 用於在運算叢集上安裝和設定主機元件，然後管理 JetStream DR 軟體。安裝過程如下：

. 檢查先決條件。
. 運作容量規劃工具取得資源和配置建議。
. 將 JetStream DR MSA 部署到指定叢集中的每個 vSphere 主機。
. 在瀏覽器中使用其 DNS 名稱啟動 MSA。
. 向 MSA 註冊 vCenter 伺服器。
. 部署 JetStream DR MSA 並註冊 vCenter Server 後，使用 vSphere Web Client 導覽至 JetStream DR 外掛程式。這可以透過導覽至資料中心 > 配置 > JetStream DR 來完成。
+
image:dr-cvo-avs-003.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 從 JetStream DR 介面完成以下任務：
+
.. 使用 I/O 篩選器包配置叢集。
+
image:dr-cvo-avs-004.png["此圖顯示輸入/輸出對話框或表示書面內容"]

.. 新增位於復原站台的 Azure Blob 儲存體。
+
image:dr-cvo-avs-005.png["此圖顯示輸入/輸出對話框或表示書面內容"]



. 從設備標籤部署所需數量的 DR 虛擬設備 (DRVA)。
+

NOTE: 使用容量規劃工具來估計所需的 DRVA 數量。

+
image:dr-cvo-avs-006.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:dr-cvo-avs-007.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 使用來自可用資料儲存或獨立共用 iSCSI 儲存池的 VMDK 為每個 DRVA 建立複製日誌磁碟區。
+
image:dr-cvo-avs-008.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 在「受保護的網域」標籤中，使用有關 Azure Blob 儲存站台、DRVA 執行個體和複製日誌的資訊建立所需數量的受保護網域。受保護域定義叢集內的特定虛擬機或一組應用程式虛擬機，這些虛擬機受到一起保護，並分配了故障轉移/故障回復操作的優先順序。
+
image:dr-cvo-avs-009.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:dr-cvo-avs-010.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 選擇要保護的虛擬機，並根據依賴關係將虛擬機分組到應用程式群組中。應用程式定義可讓您將虛擬機器集分組為邏輯群組，其中包含其啟動順序、啟動延遲以及可在復原時執行的選用應用程式驗證。
+

NOTE: 確保受保護域內的所有虛擬機器使用相同的保護模式。

+

NOTE: 回寫（VMDK）模式提供更高的效能。

+
image:dr-cvo-avs-011.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 確保複製日誌卷放置在高效能儲存上。
+
image:dr-cvo-avs-012.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 完成後，按一下「開始保護」以保護受保護的網域。這將開始將選定虛擬機器的資料複製到指定的 Blob 儲存體。
+
image:dr-cvo-avs-013.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 複製完成後，虛擬機器保護狀態標記為可恢復。
+
image:dr-cvo-avs-014.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+

NOTE: 可以設定故障轉移運作手冊來對虛擬機器進行分組（稱為復原群組）、設定啟動順序以及修改 CPU/記憶體設定以及 IP 配置。

. 按一下“設定”，然後按一下“執行手冊設定”連結來設定執行手冊群組。
+
image:dr-cvo-avs-015.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 點選「建立群組」按鈕開始建立新的運作手冊群組。
+

NOTE: 如果需要，在螢幕的下部，套用自訂前腳本和後腳本，以便在執行手冊組操作之前和之後自動執行。確保 Runbook 腳本駐留在管理伺服器上。

+
image:dr-cvo-avs-016.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 根據需要編輯 VM 設定。指定恢復虛擬機器的參數，包括啟動順序、啟動延遲（以秒為單位）、CPU 數量以及要分配的記憶體量。按一下向上或向下箭頭以變更虛擬機器的啟動順序。也提供了保留 MAC 的選項。
+
image:dr-cvo-avs-017.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 可以為群組中的個別虛擬機器手動配置靜態 IP 位址。按一下虛擬機器的 NIC 視圖連結以手動配置其 IP 位址設定。
+
image:dr-cvo-avs-018.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 點選配置按鈕儲存各個虛擬機器的 NIC 設定。
+
image:dr-cvo-avs-019.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:dr-cvo-avs-020.png["此圖顯示輸入/輸出對話框或表示書面內容"]



故障轉移和故障回復運作手冊的狀態現在均列為「已設定」。故障轉移和故障回應運作手冊群組是使用相同的初始虛擬機器群組和設定成對建立的。如果需要，可以透過點擊其各自的「詳細資料」連結並進行更改來單獨自訂任何運行手冊組的設定。

====
.在私有雲中為 AVS 安裝 JetStream DR
[%collapsible%open]
====
恢復站點 (AVS) 的最佳實踐是提前創建一個三節點的試點燈叢集。這允許預先配置恢復站點基礎設施，包括以下內容：

* 目標網路段、防火牆、DHCP 和 DNS 等服務等
* 為 AVS 安裝 JetStream DR
* 將 ANF 卷配置為資料儲存等


JetStream DR 支援關鍵任務域的接近零 RTO 模式。對於這些網域，應該預先安裝目標儲存。在這種情況下，ANF 是建議的儲存類型。


NOTE: 應在 AVS 叢集上配置包括段創建在內的網路配置以滿足本機要求。


NOTE: 根據 SLA 和 RTO 要求，您可以使用連續故障轉移或常規（標準）故障轉移模式。對於接近零的 RTO，您應該在復原站點開始持續補水。

. 若要在 Azure VMware 解決方案私有雲上安裝 JetStream DR for AVS，請使用執行指令。從 Azure 入口網站前往 Azure VMware 解決方案，選擇私有雲，然後選擇執行命令> 套件> JSDR.Configuration。
+

NOTE: Azure VMware 解決方案的預設 CloudAdmin 使用者沒有足夠的權限來為 AVS 安裝 JetStream DR。  Azure VMware 解決方案透過呼叫 JetStream DR 的 Azure VMware 解決方案來執行指令，實現了 JetStream DR 的簡化和自動化安裝。

+
以下螢幕截圖顯示了使用基於 DHCP 的 IP 位址的安裝。

+
image:dr-cvo-avs-021.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. JetStream DR for AVS 安裝完成後，刷新瀏覽器。若要存取 JetStream DR UI，請前往 SDDC 資料中心 > 設定 > JetStream DR。
+
image:dr-cvo-avs-022.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 從 JetStream DR 介面完成以下任務：
+
.. 新增用於保護本機叢集的 Azure Blob 儲存帳戶作為儲存站點，然後執行掃描網域選項。
.. 在出現的彈出對話方塊視窗中，選擇要匯入的受保護網域，然後按一下其匯入連結。
+
image:dr-cvo-avs-023.png["此圖顯示輸入/輸出對話框或表示書面內容"]



. 該域名已導入以進行恢復。前往「受保護的網域」標籤並驗證是否已選擇目標網域，或從「選擇受保護的網域」功能表中選擇所需的網域。顯示受保護域中可復原的虛擬機器清單。
+
image:dr-cvo-avs-024.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 導入受保護域後，部署 DRVA 設備。
+

NOTE: 這些步驟也可以使用 CPT 建立的計劃自動執行。

. 使用可用的 vSAN 或 ANF 資料儲存建立複製日誌卷。
. 導入受保護的網域並配置恢復 VA 以使用 ANF 資料儲存進行 VM 放置。
+
image:dr-cvo-avs-025.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+

NOTE: 確保所選網段上啟用了 DHCP，並且有足夠的可用 IP。在網域名稱恢復期間，暫時使用動態 IP。每個復原的虛擬機器（包括持續補水）都需要一個單獨的動態 IP。恢復完成後，IP 被釋放並可重複使用。

. 選擇適當的故障轉移選項（連續故障轉移或故障轉移）。在這個例子中，選擇了持續補水（持續故障轉移）。
+

NOTE: 儘管連續故障轉移和故障轉移模式在執行配置時有所不同，但兩種故障轉移模式都使用相同的步驟進行設定。故障轉移步驟是一起配置和執行的，以應對災難事件。可以隨時配置連續故障轉移，然後允許其在正常系統運作期間在背景運作。災難事件發生後，完成持續故障轉移，立即將受保護虛擬機器的所有權轉移到復原站點（接近零 RTO）。

+
image:dr-cvo-avs-026.png["此圖顯示輸入/輸出對話框或表示書面內容"]



持續故障轉移程序開始，並且可以從 UI 監控其進度。點擊「目前步驟」部分中的藍色圖示將開啟一個彈出窗口，其中顯示故障轉移過程當前步驟的詳細資訊。

====
.故障轉移和故障恢復
[%collapsible%open]
====
. 當本地環境的受保護叢集發生災難（部分或全部故障）後，您可以在中斷各個應用程式磁碟區的SnapMirror關係後，使用 Jetstream 觸發虛擬機器的故障轉移。
+
image:dr-cvo-avs-027.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:dr-cvo-avs-028.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+

NOTE: 此步驟可以輕鬆實現自動化，以促進恢復過程。

. 存取 AVS SDDC（目標端）上的 Jetstream UI 並觸發故障轉移選項以完成故障轉移。工作列顯示故障轉移活動的進度。
+
在完成故障轉移時出現的對話視窗中，可以將故障轉移任務指定為計劃的或假定為強制的。

+
image:dr-cvo-avs-029.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:dr-cvo-avs-030.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
強制故障轉移假定主站點不再可訪問，受保護域的所有權應由復原站點直接承擔。

+
image:dr-cvo-avs-031.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:dr-cvo-avs-032.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 連續故障轉移完成後，會出現一則訊息確認任務完成。任務完成後，存取復原的虛擬機器以設定 ISCSI 或 NFS 會話。
+

NOTE: 故障轉移模式變為“故障轉移中正在運行”，虛擬機器狀態變為“可恢復”。受保護域的所有虛擬機器現在都在復原站點上執行，狀態依照故障轉移運作手冊設定指定。

+

NOTE: 為了驗證故障轉移配置和基礎設施，JetStream DR 可以在測試模式下運作（測試故障轉移選項），以觀察虛擬機器及其資料從物件儲存到測試復原環境的復原情況。當在測試模式下執行故障轉移過程時，其操作類似於實際的故障轉移過程。

+
image:dr-cvo-avs-033.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 虛擬機器復原後，使用儲存災難復原進行來賓儲存。為了示範此過程，本例中使用了 SQL 伺服器。
. 登入 AVS SDDC 上復原的SnapCenter VM 並啟用 DR 模式。
+
.. 使用瀏覽器存取SnapCenter UI。
+
image:dr-cvo-avs-034.png["此圖顯示輸入/輸出對話框或表示書面內容"]

.. 在設定頁面中，導覽至設定> 全域設定> 災難復原。
.. 選擇啟用災難復原。
.. 按一下“應用”。
+
image:dr-cvo-avs-035.png["此圖顯示輸入/輸出對話框或表示書面內容"]

.. 按一下「監視」>「作業」來驗證 DR 作業是否已啟用。
+

NOTE: 應使用NetApp SnapCenter 4.6 或更高版本進行儲存災難復原。對於先前的版本，應使用應用程式一致性快照（使用SnapMirror複製），並且應執行手動恢復，以防必須在災難恢復站點恢復先前的備份。



. 確保SnapMirror關係已中斷。
+
image:dr-cvo-avs-036.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 將Cloud Volumes ONTAP中的 LUN 連接到具有相同磁碟機號碼的復原的 SQL 客戶虛擬機器。
+
image:dr-cvo-avs-037.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 開啟 iSCSI 啟動器，清除先前已中斷的會話，並為複製的Cloud Volumes ONTAP磁碟區新增目標以及多路徑。
+
image:dr-cvo-avs-038.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 確保所有磁碟都使用 DR 之前使用的相同磁碟機號碼進行連接。
+
image:dr-cvo-avs-039.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 重新啟動 MSSQL 伺服器服務。
+
image:dr-cvo-avs-040.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 確保 SQL 資源已恢復上線。
+
image:dr-cvo-avs-041.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+

NOTE: 對於 NFS，使用 mount 指令附加磁碟區並更新 `/etc/fstab`條目。

+
此時，操作可以運作且業務可以繼續正常進行。

+

NOTE: 在 NSX-T 端，可以建立單獨的專用第 1 層閘道來模擬故障轉移場景。這可確保所有工作負載可以相互通信，但不會有任何流量可以路由進出環境，從而可以執行任何分類、遏製或強化任務而不會有交叉污染的風險。此操作超出了本文檔的範圍，但可以輕鬆實現模擬隔離。



主站點重新啟動並運行後，您可以執行故障復原。  VM 保護由 Jetstream 恢復，並且必須逆轉SnapMirror關係。

. 恢復本地環境。根據災難事件的類型，可能需要復原和/或驗證受保護叢集的配置。如有必要，可能需要重新安裝 JetStream DR 軟體。
. 存取復原的本機環境，前往 Jetstream DR UI，然後選擇適當的受保護網域。受保護網站準備好故障復原後，在 UI 中選擇故障復原選項。
+

NOTE: CPT 產生的故障復原計畫也可用於啟動虛擬機器及其資料從物件儲存返回原始 VMware 環境。

+
image:dr-cvo-avs-042.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+

NOTE: 指定在復原站點中暫停虛擬機器並在受保護站點中重新啟動虛擬機器後的最大延遲。完成此程序所需的時間包括停止故障轉移虛擬機器後完成複製的時間、清理復原站點所需的時間以及在受保護站點中重新建立虛擬機器所需的時間。  NetApp建議 10 分鐘。

+
image:dr-cvo-avs-043.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 完成故障復原流程，然後確認復原虛擬機器保護和資料一致性。
+
image:dr-cvo-avs-044.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 虛擬機器恢復後，斷開輔助儲存與主機的連接並連接到主儲存。
+
image:dr-cvo-avs-045.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:dr-cvo-avs-046.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 重新啟動 MSSQL 伺服器服務。
. 驗證 SQL 資源是否已恢復連線。
+
image:dr-cvo-avs-047.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+

NOTE: 若要故障恢復到主存儲，請透過執行反向重新同步操作確保關係方向與故障轉移之前保持相同。

+

NOTE: 為了在反向重新同步操作後保留主儲存和輔助儲存的角色，請再次執行反向重新同步操作。



此過程適用於其他應用程序，如 Oracle、類似的資料庫類型以及任何其他使用來賓連接儲存的應用程式。

與往常一樣，在將關鍵工作負載轉移到生產環境之前，請先測試復原所涉及的步驟。

====


== 此解決方案的優勢

* 使用SnapMirror的高效且有彈性的複製。
* 透過ONTAP快照保留還原到任何可用的時間點。
* 從儲存、運算、網路和應用程式驗證步驟，恢復數百到數千台虛擬機器所需的所有步驟均可完全自動化。
* SnapCenter使用不會改變複製磁碟區的克隆機制。
+
** 這避免了磁碟區和快照資料損壞的風險。
** 避免 DR 測試工作流程期間的複製中斷。
** 利用 DR 資料進行 DR 以外的工作流程，例如開發/測試、安全測試、修補程式和升級測試以及補救測試。


* CPU 和 RAM 最佳化可以透過恢復到較小的運算叢集來幫助降低雲端成本。

