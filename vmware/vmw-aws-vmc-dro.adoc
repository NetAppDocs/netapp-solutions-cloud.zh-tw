---
sidebar: sidebar 
permalink: vmware/vmw-aws-vmc-dro.html 
keywords: NetApp Solutions, hybrid, multicloud, multi cloud, hyperscalers, vmware, disaster recovery orchestrator, DRO 
summary:  
---
= TR-4955：使用 FSx ONTAP和 VMC 進行災難復原 (AWS VMware Cloud)
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
災難復原編排器（DRO；具有 UI 的腳本解決方案）可用於無縫復原從本機複製到 FSx ONTAP 的工作負載。  DRO 可自動執行從SnapMirror等級到 VM 註冊到 VMC 再到直接在 NSX-T 上進行網路對映的復原。所有 VMC 環境均包含此功能。

NetApp的 Niyaz Mohamed



== 概況

災難復原到雲端是一種具有彈性且經濟高效的方法，可以保護工作負載免受網站中斷和資料損壞事件（例如勒索軟體）的影響。透過NetApp SnapMirror技術，本機 VMware 工作負載可以複製到在 AWS 中執行的 FSx ONTAP 。

災難復原編排器（DRO；具有 UI 的腳本解決方案）可用於無縫復原從本機複製到 FSx ONTAP 的工作負載。  DRO 可自動執行從SnapMirror等級到 VM 註冊到 VMC 再到直接在 NSX-T 上進行網路對映的復原。所有 VMC 環境均包含此功能。

image:dro-vmc-001.png["此圖描述了本機資料中心、VMware Cloud on AWS SDDC 執行個體和Amazon FSx ONTAP之間的結構和互連。這包括SnapMirror複製、DRaaS Ops 流量、網際網路或直接連線以及 VMware Transit Connect。"]



== 入門



=== 在 AWS 上部署並設定 VMware Cloud

link:https://www.vmware.com/products/vmc-on-aws.html["AWS 上的 VMware Cloud"^]為 AWS 生態系統中基於 VMware 的工作負載提供雲端原生體驗。每個 VMware 軟體定義資料中心 (SDDC) 都在 Amazon 虛擬私有雲 (VPC) 中運行，並提供完整的 VMware 堆疊（包括 vCenter Server）、NSX-T 軟體定義網路、vSAN 軟體定義儲存以及一個或多個為工作負載提供運算和儲存資源的 ESXi 主機。若要在 AWS 上設定 VMC 環境，請依照下列步驟操作link:vmw-aws-vmc-setup.html["關聯"^]。指示燈組也可用於 DR 目的。


NOTE: 在初始版本中，DRO 支援現有的指示燈集群。按需 SDDC 創建功能將在即將發布的版本中提供。



=== 配置 FSx ONTAP

Amazon FSx ONTAP是一項完全託管的服務，它基於流行的NetApp ONTAP檔案系統構建，提供高度可靠、可擴展、高效且功能豐富的文件儲存。請按照此處的步驟操作link:vmw-aws-vmc-nfs-ds-overview.html["關聯"^]配置和配置 FSx ONTAP。



=== 部署並配置SnapMirror到 FSx ONTAP

下一步是使用NetApp BlueXP並發現 AWS 實例上配置的 FSx ONTAP ，並以適當的頻率和NetApp Snapshot 副本保留將所需的資料儲存磁碟區從本機環境複製到 FSx ONTAP ：

image:dro-vmc-002.png["該圖描繪了BlueXP Canvas 關係圖，顯示了啟用的服務之間的各種互動。"]

請依照此連結中的步驟配置BlueXP。您也可以使用NetApp ONTAP CLI 透過此連結安排複製。


NOTE: SnapMirror關係是先決條件，必須事先建立。



== DRO安裝

若要開始使用 DRO，請在指定的 EC2 執行個體或虛擬機器上使用 Ubuntu 作業系統，以確保您符合先決條件。然後安裝該套件。



=== 先決條件

* 確保與來源和目標 vCenter 和儲存系統的連接存在。
* 如果您使用 DNS 名稱，則應該進行 DNS 解析。否則，您應該使用 vCenter 和儲存系統的 IP 位址。
* 建立具有root權限的使用者。您也可以將 sudo 與 EC2 執行個體一起使用。




=== OS 需求

* Ubuntu 20.04 (LTS)，最低配置 2GB 記憶體和 4 個 vCPU
* 必須在指定的代理虛擬機器上安裝以下軟體包：
+
** Docker
** Docker-compose
** 傑




更改權限 `docker.sock`： `sudo chmod 666 /var/run/docker.sock` 。


NOTE: 這 `deploy.sh`腳本執行所有必要的先決條件。



=== 安裝包

. 在指定虛擬機器上下載安裝包：
+
[listing]
----
git clone https://github.com/NetApp/DRO-AWS.git
----
+

NOTE: 此代理程式可以安裝在本機或 AWS VPC 內。

. 解壓縮包，執行部署腳本，輸入主機IP（例如10.10.10.10）。
+
[listing]
----
tar xvf DRO-prereq.tar
----
. 導航至目錄並執行部署腳本，如下所示：
+
[listing]
----
sudo sh deploy.sh
----
. 使用以下方式存取 UI：
+
[listing]
----
https://<host-ip-address>
----
+
使用以下預設憑證：

+
[listing]
----
Username: admin
Password: admin
----



NOTE: 可以使用“更改密碼”選項來更改密碼。

image:dro-vmc-003.png["災難復原協調器登入畫面。"]



== DRO 配置

正確配置 FSx ONTAP和 VMC 後，您可以開始設定 DRO，以使用 FSx ONTAP上的唯讀SnapMirror副本自動將本機工作負載還原到 VMC。

NetApp建議在 AWS 中部署 DRO 代理，並將其部署到部署 FSx ONTAP 的相同 VPC（也可以對等連接），以便 DRO 代理可以透過網路與您的內部元件以及 FSx ONTAP和 VMC 資源進行通訊。

第一步是發現並將本機和雲端資源（vCenter 和儲存）新增至 DRO。在支援的瀏覽器中開啟 DRO 並使用預設使用者名稱和密碼（admin/admin）並新增網站。也可以使用「發現」選項新增網站。新增以下平台：

* 本地
+
** 本機 vCenter
** ONTAP儲存系統


* 雲端
+
** VMC vCenter
** FSx ONTAP




image:dro-vmc-004.png["臨時佔位符圖像描述。"]

image:dro-vmc-005.png["DRO 網站概覽頁麵包含來源網站和目標網站。"]

新增後，DRO 會執行自動發現並顯示從來源儲存到 FSx ONTAP具有對應SnapMirror副本的虛擬機器。  DRO 會自動偵測虛擬機器使用的網路和連接埠群組並填入它們。

image:dro-vmc-006.png["自動發現畫麵包含 219 個虛擬機器和 10 個資料儲存區。"]

下一步是將所需的虛擬機器分組到功能組中，作為資源組。



=== 資源分組

新增平台後，您可以將要還原的虛擬機器分組到資源組中。  DRO 資源群組可讓您將一組從屬虛擬機器分組為邏輯群組，這些邏輯群組包含它們的啟動順序、啟動延遲以及可在復原時執行的選用應用程式驗證。

若要開始建立資源組，請完成以下步驟：

. 存取*資源組*，然後按一下*建立新資源組*。
. 在「*新資源組*」下，從下拉式選單中選擇來源站點，然後按一下「*建立*」。
. 提供*資源組詳細資訊*並點選*繼續*。
. 使用搜尋選項選擇適當的虛擬機器。
. 為所選虛擬機器選擇啟動順序和啟動延遲（秒）。透過選擇每個虛擬機器並設定其優先順序來設定開機順序。所有虛擬機器的預設值都是三。
+
選項如下：

+
1 – 第一台啟動的虛擬機 3 – 預設 5 – 最後一個啟動的虛擬機

. 按一下“建立資源組”。


image:dro-vmc-007.png["包含兩個條目的資源組清單的螢幕截圖：Test 和 DemoRG1。"]



=== 複製計劃

您需要一個在災難發生時恢復應用程式的計劃。從下拉式選單中選擇來源和目標 vCenter 平台，並選擇要包含在該計劃中的資源組，以及應用程式應如何恢復和啟動的分組（例如，網域控制器，然後是第 1 層，然後是第 2 層，等等）。這類計劃有時也稱為藍圖。若要定義復原計劃，請導覽至「*複製計劃*」標籤並按一下「*新複製計劃*」。

若要開始建立複製計劃，請完成以下步驟：

. 存取*複製計劃*，然後按一下*建立新的複製計劃*。
+
image:dro-vmc-008.png["包含一個名為 DemoRP 的計劃的複製計劃畫面的螢幕截圖。"]

. 在「*新複製計畫*」下，提供計畫名稱並透過選擇來源網站、關聯 vCenter、目標網站和關聯 vCenter 新增復原對應。
+
image:dro-vmc-009.png["複製計劃詳細資訊的螢幕截圖，包括恢復映射。"]

. Recovery映射完成後，選擇叢集映射。
+
image:dro-vmc-010.png["臨時佔位符圖像描述。"]

. 選擇*資源組詳情*並點選*繼續*。
. 設定資源組的執行順序。當存在多個資源組時，此選項可讓您選擇操作順序。
. 完成後，選擇網路對應到適當的網段。這些段應該已經在 VMC 中配置，因此請選擇適當的段來對應 VM。
. 根據虛擬機器的選擇，自動選擇資料儲存映射。
+

NOTE: SnapMirror處於磁碟區層級。因此，所有虛擬機器都被複製到複製目標。確保選擇資料儲存區中的所有虛擬機器。如果未選擇，則僅處理複製計劃中的虛擬機器。

+
image:dro-vmc-011.png["臨時佔位符圖像描述。"]

. 在 VM 詳細資訊下，您可以選擇調整 VM 的 CPU 和 RAM 參數的大小；當將大型環境還原到較小的目標叢集或進行 DR 測試時，這非常有用，而無需配置一對一的實體 VMware 基礎架構。此外，您還可以修改資源組中所有選定虛擬機器的啟動順序和啟動延遲（秒）。如果需要對資源組啟動順序選擇期間選擇的順序進行任何更改，則可以選擇修改啟動順序。預設情況下，使用在資源組選擇期間選擇的啟動順序；但是，可以在此階段執行任何修改。
+
image:dro-vmc-012.png["臨時佔位符圖像描述。"]

. 按一下「建立複製計劃」。
+
image:dro-vmc-013.png["臨時佔位符圖像描述。"]



建立複製計劃後，可以根據需求執行故障轉移選項、測試故障轉移選項或遷移選項。在故障轉移和測試故障轉移選項期間，使用最新的SnapMirror Snapshot 副本，或可以從時間點 Snapshot 副本中選擇特定的 Snapshot 副本（根據SnapMirror的保留策略）。如果您面臨勒索軟體之類的損壞事件，則時間點選項可能非常有用，其中最新的副本已被破壞或加密。 DRO 顯示所有可用的時間點。若要使用複製計畫中指定的設定觸發故障轉移或測試故障轉移，您可以按一下「故障轉移」或「測試故障轉移」。

image:dro-vmc-014.png["臨時佔位符圖像描述。"] image:dro-vmc-015.png["在此畫面中，您將獲得卷宗快照詳細信息，並可以選擇使用最新快照或選擇特定快照。"]

可以在任務選單中監控複製計劃：

image:dro-vmc-016.png["任務選單顯示複製計畫的所有作業和選項，也允許您查看日誌。"]

觸發故障轉移後，可以在 VMC vCenter（虛擬機器、網路、資料儲存）中看到復原的項目。預設情況下，虛擬機器將恢復到工作負載資料夾。

image:dro-vmc-017.png["臨時佔位符圖像描述。"]

可以在複製計劃層級觸發故障恢復。對於測試故障轉移，可使用拆除選項來回變更並刪除FlexClone關係。與故障轉移相關的故障回復是一個兩步驟過程。選擇複製計劃並選擇*反向資料同步*。

image:dro-vmc-018.png["複製計劃概述的螢幕截圖，下拉式選單包含反向資料同步選項。"] image:dro-vmc-019.png["臨時佔位符圖像描述。"]

一旦完成後，您可以觸發故障復原以返回原始生產網站。

image:dro-vmc-020.png["複製計畫概述的螢幕截圖，下拉式選單包含故障回應選項。"] image:dro-vmc-021.png["DRO 摘要頁面的螢幕截圖，其中原始生產網站已啟動並運行。"]

從NetApp BlueXP中，我們可以看到對應磁碟區（作為讀寫磁碟區對應到 VMC 的磁碟區）的複製健康狀況已中斷。在測試故障轉移期間，DRO 不會對應目標磁碟區或副本磁碟區。相反，它會建立所需SnapMirror （或 Snapshot）實例的FlexClone副本並公開該FlexClone實例，這樣就不會消耗 FSx ONTAP的額外實體容量。此流程可確保磁碟區不會被修改，並且即使在 DR 測試或分類工作流程期間，複製作業也可以繼續。此外，此過程可確保如果發生錯誤或恢復損壞的數據，則可以清理恢復，而不會有副本被破壞的風險。

image:dro-vmc-022.png["臨時佔位符圖像描述。"]



=== 勒索軟體恢復

從勒索軟體中恢復可能是一項艱鉅的任務。具體來說，IT 組織很難確定安全返回點在哪裡，而且一旦確定，就很難保護恢復的工作負載免受例如休眠惡意軟體或易受攻擊的應用程式的重複攻擊。

DRO 可讓您從任何可用時間點復原系統，從而解決這些問題。您還可以將工作負載恢復到功能正常但隔離的網路中，以便應用程式可以在不會暴露於南北流量的位置運行並相互通訊。這為您的安全團隊提供了一個安全的地方來進行取證，並確保沒有隱藏或休眠的惡意軟體。



== 好處

* 使用高效且有彈性的SnapMirror複製。
* 透過 Snapshot 副本保留恢復到任何可用的時間點。
* 完全自動化從儲存、運算、網路和應用程式驗證步驟中恢復數百到數千台虛擬機器所需的所有步驟。
* 使用ONTAP FlexClone技術進行工作負載恢復，採用的方法是不改變複製磁碟區。
+
** 避免磁碟區或 Snapshot 副本的資料損壞風險。
** 避免 DR 測試工作流程期間的複製中斷。
** DR 資料與雲端運算資源的潛在用途，可用於 DR 以外的工作流程，例如開發測試、安全測試、修補程式或升級測試以及補救測試。


* 透過允許恢復到較小的運算集群，CPU 和 RAM 優化有助於降低雲端成本。

